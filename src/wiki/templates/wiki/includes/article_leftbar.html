{% load i18n sekizai_tags static %}

<form method="POST" action="{% url 'save_progress' %}" id="progress-form">
  {% csrf_token %}
  {{ form.as_p }}  <!-- Django form fields -->

  <h4>{% trans "Select Location in Media" %}</h4>
  <select id="book-select" name="book" style="width: 200px;"></select>
  <select id="chapter-select" name="chapter" disabled style="width: 200px;"></select>

  <button type="submit" style="display: none;" id="submit-btn">Submit</button>
</form>

{% addtoblock "js" %}
<script type="text/javascript" src="{% static 'wiki/select2/js/select2.min.js' %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript">
  $(document).ready(function () {
    function getBaseWikiPath(pathname) {
        const basePathOptions = ['/book/', '/tv/'];
        let baseWiki = '';

        basePathOptions.some(option => {
          const index = pathname.indexOf(option);
          if (index !== -1) {
            baseWiki = pathname.substring(0, index + option.length);
            return true;
          }
          return false;
        });

        return baseWiki || pathname;
    }

    let firstSelectionMade = false;
    let firstSelectionValue = '';
    let baseWiki = getBaseWikiPath(window.location.pathname);

    const isBookWiki = baseWiki.includes('/book/');
    let outerSelectionPlaceholder = isBookWiki ? "Select Book" : "Select Season";
    let outerDefaultSearch = isBookWiki ? "Book" : "Season";
    let innerSelectionPlaceholder = isBookWiki ? "Select Chapter" : "Select Episode";
    let innerDefaultSearch = isBookWiki ? "Chapter" : "Episode";

    $('#book-select').select2({
      dropdownAutoWidth: true,
      placeholder: outerSelectionPlaceholder,
      ajax: {
        url: function (params) {
            if (!params.term)
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + outerDefaultSearch + "&wiki=" + baseWiki;
            else
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + params.term + "&wiki=" + baseWiki;
        },
        processResults: function (data) {
          let ret = [];
          data.forEach(function (val) {
            ret.push({ "id": val, "text": val });
          });
          return { results: ret };
        },
      },
    });

    $('#chapter-select').select2({
      dropdownAutoWidth: true,
      placeholder: innerSelectionPlaceholder,
      ajax: {
        url: function (params) {
            if (!params.term)
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + innerDefaultSearch + "&subwiki=" + firstSelectionValue;
            else
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + params.term + "&subwiki=" + firstSelectionValue;
        },
        processResults: function (data) {
          let ret = [];
          data.forEach(function (val) {
            ret.push({ "id": val, "text": val });
          });
          return { results: ret };
        },
      },
    });

    $('#book-select').on('select2:select', function (e) {
        $('#chapter-select').val(null).trigger('change').prop('disabled', true);
        firstSelectionValue = $('#book-select').val().split("wiki:")[1];
        $('#chapter-select').prop('disabled', false);
        $('#chapter-select').trigger('change');
    });

    $('#chapter-select').on('select2:select', function (e) {
      $('#submit-btn').click();  // Submit form when chapter is selected
    });

  });
</script>
{% endaddtoblock %}

{% addtoblock "css" %}
<link rel="stylesheet" href="{% static 'wiki/select2/css/select2.min.css' %}" type="text/css" />
{% endaddtoblock %}
