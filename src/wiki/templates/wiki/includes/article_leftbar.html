{% load i18n sekizai_tags static %}

<div id="progress-select">
  <h4>{% trans "Select Location in Media" %}</h4>
  <select id="book-select" style="width: 200px;"></select>
  <select id="chapter-select" disabled style="width: 200px;"></select>
</div>

{% addtoblock "js" %}
<script type="text/javascript" src="{% static 'wiki/select2/js/select2.min.js' %}"></script>
{% endaddtoblock %}

{% addtoblock "js" %}
<script type="text/javascript">
  $(document).ready(function () {

    function getBaseWikiPath(pathname) {
        const basePathOptions = ['/book/', '/tv/'];
        let baseWiki = '';

        basePathOptions.some(option => {
          const index = pathname.indexOf(option);
          if (index !== -1) {
            baseWiki = pathname.substring(0, index + option.length);
            return true;
          }
          return false;
        });

        return baseWiki || pathname;
    }

    // Variables to track if selections have been made
    let firstSelectionMade = false;
    let secondSelectionMade = false;
    let firstSelectionValue = '';

    let baseWiki = getBaseWikiPath(window.location.pathname); // Updated to use baseWiki

    const isBookWiki = baseWiki.includes('/book/');
    let outerSelectionPlaceholder = isBookWiki ? "Select Book" : "Select Season";
    let outerDefaultSearch = isBookWiki ? "Book" : "Season";
    let innerSelectionPlaceholder = isBookWiki ? "Select Chapter" : "Select Episode";
    let innerDefaultSearch = isBookWiki ? "Chapter" : "Episode";

    $('#book-select').select2({
      dropdownAutoWidth: true,
      placeholder: outerSelectionPlaceholder,
      ajax: {
        url: function (params) {
            if (!params.term)
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + outerDefaultSearch + "&wiki=" + baseWiki;
            else
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + params.term + "&wiki=" + baseWiki;
        },
        processResults: function (data) {
          let ret = [];
          data.forEach(function (val) {
            ret.push({ "id": val, "text": val });
          });
          return { results: ret };
        },
      },
    });

    $('#chapter-select').select2({
      dropdownAutoWidth: true,
      placeholder: innerSelectionPlaceholder,
      ajax: {
        url: function (params) {
            if (!params.term)
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + innerDefaultSearch + "&subwiki=" + firstSelectionValue;
            else
                return "{% url 'wiki:citations_query_urlpath' path=urlpath.path article_id=article.id %}?query=" + params.term + "&subwiki=" + firstSelectionValue;
        },
        processResults: function (data) {
          let ret = [];
          data.forEach(function (val) {
            ret.push({ "id": val, "text": val });
          });
          return { results: ret };
        },
      },
    });

    $('#book-select').on('select2:select', function (e) {
        $('#chapter-select').val(null).trigger('change').prop('disabled', true);
        firstSelectionMade = true;
        firstSelectionValue = $('#book-select').val().split("wiki:")[1];
        $('#chapter-select').prop('disabled', false);
        $('#chapter-select').trigger('change');
    });

    // When a chapter or episode is selected, send progress to the server
    $('#chapter-select').on('select2:select', function (e) {
      const progress = e.params.data.id;

      $.ajax({
          url: "/save_user_progress/", // ISSUE WITH URL REVERSING. HARD CODED TEMPORARILY
          type: "POST",
          data: {
              'wiki_id': baseWiki,  // Use baseWiki as the wiki_id
              'progress': progress,
              'csrfmiddlewaretoken': '{{ csrf_token }}' // Include CSRF token for security
          },
          success: function (response) {
              if (response.status === 'success') {
                  console.log('User progress updated successfully');
              } else {
                  console.log('Failed to update user progress');
              }
          },
          error: function () {
              console.log('Error occurred while updating user progress');
          }
      });
    });

  });
</script>
{% endaddtoblock %}

{% addtoblock "css" %}
<link rel="stylesheet" href="{% static 'wiki/select2/css/select2.min.css' %}" type="text/css" />
{% endaddtoblock %}
